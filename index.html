<script>
let products = [];
let currentProduct = null;
let currentImageIndex = 0;

// Carregar produtos do JSON externo
async function loadProducts() {
  try {
    const response = await fetch("produtos.json");
    const data = await response.json();

    products = data.map(p => {
      if (!p.category) p.category = "Acessório";
      return p;
    });

    renderProducts(products);
  } catch (err) {
    console.error("Erro ao carregar produtos.json", err);
  }
}

// Renderizar produtos nos cards
function renderProducts(products) {
  const newC = document.getElementById('new-phones-container');
  const usedC = document.getElementById('used-phones-container');
  const accC = document.getElementById('accessories-container');

  newC.innerHTML = '';
  usedC.innerHTML = '';
  accC.innerHTML = '';

  products.forEach(p => {
    const card = document.createElement('div');
    card.className = 'bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition cursor-pointer';
    card.innerHTML = `
      <div class="h-48 bg-gray-100 flex items-center justify-center p-4">
        <img src="${p.images[0]}" alt="${p.name}" class="max-h-full max-w-full object-contain">
      </div>
      <div class="p-4">
        <h3 class="text-lg font-bold text-gray-800 mb-1">${p.name}</h3>
        <p class="text-gray-600 text-sm mb-2">${p.description}</p>
        ${p.color ? `<p class="text-gray-600 text-sm mb-2"><strong>Cor:</strong> ${p.color}</p>` : ''}
        ${p.condition ? `<p class="text-gray-600 text-sm mb-2"><strong>Estado:</strong> ${p.condition}</p>` : ''}
        <p class="text-xl font-bold text-blue-600 mb-3">
          ${typeof p.price === 'object'
            ? `<strong>À vista:</strong> ${p.price.avista}<br><strong>Parcelado:</strong> ${p.price.parcelado}`
            : p.price}
        </p>
        <button class="view-product bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Ver Produto</button>
      </div>
    `;

    // Abrir modal ao clicar em "Ver Produto"
    card.querySelector('.view-product').addEventListener('click', () => openProductModal(p));

    if (p.category === "Novo") newC.appendChild(card);
    else if (p.category === "Seminovo") usedC.appendChild(card);
    else accC.appendChild(card);
  });
}

// Abrir modal do produto com carrossel, zoom e WhatsApp
function openProductModal(product) {
  const modal = document.querySelector('.product-modal');
  const modalContent = modal.querySelector('div.relative');
  let currentImageIndex = 0;
  let zoomed = false;

  function showImage(index) {
    const mainImage = modalContent.querySelector('#modal-main-image');
    mainImage.src = product.images[index];
    zoomed = false;
    mainImage.style.transform = "scale(1)";
    mainImage.style.cursor = "zoom-in";

    const thumbnails = modalContent.querySelectorAll('.gallery-thumbnail');
    thumbnails.forEach((thumb, i) => thumb.classList.toggle('active', i === index));
  }

  modalContent.innerHTML = `
    <div class="p-6 relative">
      <h2 class="text-2xl font-bold mb-4">${product.name}</h2>
      
      <div id="modal-main-image-container" class="mb-4 relative">
        <img id="modal-main-image" src="${product.images[0]}" class="w-full max-h-96 object-contain mb-2 cursor-zoom-in">
        <button id="prev-image" class="absolute top-1/2 left-2 transform -translate-y-1/2 bg-gray-300 text-gray-800 px-2 py-1 rounded-full hover:bg-gray-400 transition">&larr;</button>
        <button id="next-image" class="absolute top-1/2 right-2 transform -translate-y-1/2 bg-gray-300 text-gray-800 px-2 py-1 rounded-full hover:bg-gray-400 transition">&rarr;</button>
      </div>

      <div class="flex space-x-2 mb-4">
        ${product.images.map((img, i) => `<img src="${img}" class="gallery-thumbnail w-20 h-20 object-contain rounded-lg border cursor-pointer ${i===0?'active':''}" data-index="${i}">`).join('')}
      </div>

      <p class="text-gray-700 mb-2">${product.description}</p>
      ${product.color ? `<p class="text-gray-700 mb-2"><strong>Cor:</strong> ${product.color}</p>` : ''}
      <p class="text-xl font-bold text-blue-600 mb-4">
        ${typeof product.price === 'object' ? `<strong>À vista:</strong> ${product.price.avista}<br><strong>Parcelado:</strong> ${product.price.parcelado}` : product.price}
      </p>

      <button id="whatsapp-button" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">Enviar via WhatsApp</button>
      <button onclick="closeProductModal()" class="mt-4 bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition">Fechar</button>
    </div>
  `;

  // Miniaturas
  modalContent.querySelectorAll('.gallery-thumbnail').forEach(thumb => {
    thumb.addEventListener('click', () => {
      currentImageIndex = parseInt(thumb.dataset.index);
      showImage(currentImageIndex);
    });
  });

  // Setas
  modalContent.querySelector('#prev-image').addEventListener('click', () => {
    currentImageIndex = (currentImageIndex - 1 + product.images.length) % product.images.length;
    showImage(currentImageIndex);
  });

  modalContent.querySelector('#next-image').addEventListener('click', () => {
    currentImageIndex = (currentImageIndex + 1) % product.images.length;
    showImage(currentImageIndex);
  });

  // Zoom ao clicar na imagem principal
  const mainImage = modalContent.querySelector('#modal-main-image');
  mainImage.addEventListener('click', () => {
    zoomed = !zoomed;
    if (zoomed) {
      mainImage.style.transform = "scale(2)";
      mainImage.style.cursor = "zoom-out";
    } else {
      mainImage.style.transform = "scale(1)";
      mainImage.style.cursor = "zoom-in";
    }
  });

  // Botão WhatsApp dentro do modal
  modalContent.querySelector('#whatsapp-button').addEventListener('click', () => {
    const userName = prompt("Qual é o seu nome?");
    if (userName) {
      const msg = `Olá! Meu nome é ${userName} e tenho interesse no produto ${product.name} no valor ${typeof product.price === 'object' ? product.price.avista : product.price}`;
      window.open(`https://wa.me/5564999518536?text=${encodeURIComponent(msg)}`, "_blank");
    }
  });

  modal.classList.add('active');
}

// Fechar modal
function closeProductModal() {
  document.querySelector('.product-modal').classList.remove('active');
}

document.addEventListener('DOMContentLoaded', loadProducts);
</script>
